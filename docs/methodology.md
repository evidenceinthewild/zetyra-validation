# Validation Methodology

This document describes how Zetyra calculators are validated against reference implementations and published benchmarks.

## Overview

Each calculator is validated using three approaches:

1. **Analytical verification** - Comparison against closed-form formulas
2. **Reference package comparison** - Comparison against established R/Python packages
3. **Property testing** - Verification of mathematical properties (monotonicity, symmetry, etc.)

## Sample Size Calculators

### Continuous Outcomes (Two-Sample T-Test)

**Reference:** R `pwr::pwr.t.test`

**Formula:**
```
n = 2 × ((z_α + z_β) / d)²
```

where:
- `d = (μ₂ - μ₁) / σ` (Cohen's d)
- `z_α = Φ⁻¹(1 - α/2)` for two-sided test
- `z_β = Φ⁻¹(power)`

**Validation tolerance:** ≤1% relative difference in sample size

### Binary Outcomes (Two-Proportion Z-Test)

**Reference:** Pooled-variance z-test (Chow et al., Lachin)

**Formula:** Uses pooled variance under H0 and separate variances under H1:
```
n₁ = ((z_α × √((1+1/r) × p̄(1-p̄)) + z_β × √(p₁(1-p₁) + p₂(1-p₂)/r)) / |p₂-p₁|)²
```

Effect size reported as Cohen's h:
```
h = 2 × arcsin(√p₂) - 2 × arcsin(√p₁)
```

Note: This differs from pwr::pwr.2p.test which uses arcsine transformation throughout.

**Validation tolerance:** ≤1% relative difference in sample size

### Survival Outcomes (Log-Rank Test)

**Reference:** R `gsDesign::nSurv`

**Formula:** Schoenfeld formula:
```
d = ((z_α + z_β) / log(HR))² × (1 + r)² / r
```

where `d` = required events, `r` = allocation ratio

**Validation tolerance:** ≤2% relative difference in sample size

## CUPED Calculator

**Reference:** Deng et al. (2013) analytical formulas

**Key formula:** Variance reduction factor = `1 - ρ²`

### Properties Validated

1. Zero correlation → no sample size reduction
2. Symmetry: `|ρ|` determines reduction (sign irrelevant)
3. Higher correlation → greater sample size reduction
4. Variance reduction exactly equals `1 - ρ²`

**Validation tolerance:** ≤0.1% for variance reduction factor

## Group Sequential Design

**Reference:** R `gsDesign` package

### Spending Functions

**O'Brien-Fleming (one-sided):**
```
α*(t) = 2 - 2Φ(z_α / √t)
```
where z_α is the one-sided critical value (e.g., z_{0.025} = 1.96).

**Pocock:**
```
α*(t) = α × ln(1 + (e-1)t)
```

### Properties Validated

1. O'Brien-Fleming: Conservative at early looks (high first boundary)
2. Pocock: More uniform boundaries across looks
3. Sample size inflation: 2-5% for typical designs
4. Final boundary close to fixed design z-value
5. Cumulative alpha spent equals nominal alpha at final look

**Validation tolerance:** ≤0.05 absolute difference in Z-score boundaries

## Bayesian Predictive Power

**Reference:** Analytical conjugate formulas

### Normal-Normal Model (Continuous)

**Posterior:**
```
θ | x ~ N(μ₁, σ₁²)

where:
- σ₁² = 1 / (1/σ₀² + 1/σ_data²)
- μ₁ = σ₁² × (μ₀/σ₀² + x/σ_data²)
```

### Beta-Binomial Model (Binary)

**Posterior:**
```
π | x ~ Beta(α + successes, β + failures)
```

### Properties Validated

1. Strong positive effect → high predictive probability
2. Null effect → low predictive probability
3. Optimistic prior increases predictive probability
4. Posterior parameters match conjugate formulas exactly

**Validation tolerance:**
- Posterior parameters: exact match
- Predictive probability: ≤2% (Monte Carlo variability)

## Commercial Software Comparison

Results are compared against:
- **PASS 2024** (NCSS)
- **nQuery 9.5** (Statsols)
- **East 6.5** (Cytel)

These comparisons are documented in `results/validation_summary.md` (generated by `python generate_report.py`).

## Running Validation

### Python
```bash
cd validation
python validate_all.py
```

### R
```bash
cd R
Rscript validate_all.R
```

### Local Testing
Override API URL for local testing:
```bash
python validate_all.py http://localhost:8080/api/v1/validation
Rscript validate_all.R http://localhost:8080/api/v1/validation
```

## References

1. Deng, A., Xu, Y., Kohavi, R., & Walker, T. (2013). Improving the sensitivity of online controlled experiments by utilizing pre-experiment data. WSDM.

2. Jennison, C., & Turnbull, B. W. (2000). Group Sequential Methods with Applications to Clinical Trials. Chapman & Hall/CRC.

3. Gelman, A., et al. (2013). Bayesian Data Analysis (3rd ed.). CRC Press.

4. Schoenfeld, D. (1983). Sample-size formula for the proportional-hazards regression model. Biometrics.
